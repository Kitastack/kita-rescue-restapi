const emailTemplate = (_code: string) =>
  `<div style="width:100%;height:100%;padding:0;Margin:0"><img id="m_-6415224778485533433mshidden" src="https://ci4.googleusercontent.com/proxy/1HVJae5LZjXl6LUY16fZxdwAylfcJkRR2HA842YeG2sz1kXnRZelr6yD8exnLc4Kr3Fucxtv41ifNJAW03f9y2WrCqWVsprnMBveIPF3ft3fnDVfsX8bfbTicBmMMRZZsMj_Rkr_W1j0-qVMzfl6_Rxypabftb4jjWkX=s0-d-e1-ft#https://esputnik.com/repository/applications/commons/hidden.png?iid=00bbce10-1cf4-11ee-96dc-7b2d00fb3a50" alt="" style="display:block;width:0px;height:0px;float:none;opacity:0.0;border:0px solid;margin:0px" class="CToWUd" data-bit="iit"> <div style="background-color:#f1f1f1"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px;padding:0;Margin:0;width:100%;height:100%;background-repeat:repeat;background-position:center top;background-color:#f1f1f1"> <tbody><tr> <td valign="top" style="padding:0;Margin:0"> <table class="m_-6415224778485533433es-header" cellspacing="0" cellpadding="0" align="center" style="border-collapse:collapse;border-spacing:0px;width:100%;table-layout:fixed!important;background-color:transparent;background-repeat:repeat;background-position:center top"> <tbody><tr> <td align="center" style="padding:0;Margin:0"> <table class="m_-6415224778485533433es-header-body" style="border-collapse:collapse;border-spacing:0px;background-color:transparent;width:600px" cellspacing="0" cellpadding="0" align="center"> <tbody><tr> <td align="left" style="padding:0;Margin:0;padding-top:30px;padding-bottom:25px"> <table class="m_-6415224778485533433es-left" cellspacing="0" cellpadding="0" align="left" style="border-collapse:collapse;border-spacing:0px;float:left"> <tbody><tr> <td class="m_-6415224778485533433es-m-p20b" align="left" style="padding:0;Margin:0;width:292px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr> <td align="left" style="padding:0;Margin:0;font-size:0"><a href="https://viewstripo.email" style="text-decoration:underline;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;font-size:14px;color:#ffffff" target="_blank" data-saferedirecturl="https://www.google.com/url?q=https://viewstripo.email&amp;source=gmail&amp;ust=1688840886807000&amp;usg=AOvVaw2hIsjnJg72Qd0WC4mHztu6"><img src="https://ci6.googleusercontent.com/proxy/9pEvgElSd-emVIZs-bbbdZATZX-PFRCM5anSsGsWgvuF2es1dHhfha59aR53zpI-LVmRW5a3KpM9qMnpX1YvqJFgA8FuB_kgSXFf2JMOyh1PxuE_tC4mmxtC-l99HSZm0-C599PDJ8OiwdoT5dxT9RflwRzjWFf28hMyTCe2u1bmTA8JQrByUz3mY-o8WGUKuwMpaDh-BIYvp6rVFnzb=s0-d-e1-ft#https://qohhoh.stripocdn.email/content/guids/CABINET_5b3be2e4613fbd407ba3620ebd194679d12feb337b44475c04a88776572ece01/images/109216580.jpeg" alt="" style="display:block;font-size:14px;border:0;outline:none;text-decoration:none" width="72" class="CToWUd" data-bit="iit"></a></td> </tr> </tbody></table></td> </tr> </tbody></table> <table class="m_-6415224778485533433es-right" cellspacing="0" cellpadding="0" align="right" style="border-collapse:collapse;border-spacing:0px;float:right"> <tbody><tr> <td align="left" style="padding:0;Margin:0;width:288px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr> <td align="left" style="padding:0;Margin:0"><p style="Margin:0;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;line-height:23px;letter-spacing:0;color:#ffffff;font-size:15px">&nbsp;</p></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table> <table class="m_-6415224778485533433es-content" cellspacing="0" cellpadding="0" align="center" style="border-collapse:collapse;border-spacing:0px;width:100%;table-layout:fixed!important"> <tbody><tr> <td align="center" style="padding:0;Margin:0"> <table class="m_-6415224778485533433es-content-body" style="border-collapse:collapse;border-spacing:0px;background-color:#ffffff;border-top:1px solid #dddddd;border-right:1px solid #dddddd;border-left:1px solid #dddddd;width:600px;border-bottom:1px solid #dddddd" cellspacing="0" cellpadding="0" bgcolor="#ffffff" align="center"> <tbody><tr> <td align="left" style="Margin:0;padding-top:40px;padding-right:40px;padding-bottom:50px;padding-left:40px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr> <td valign="top" align="center" style="padding:0;Margin:0;width:518px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr> <td align="left" style="padding:0;Margin:0;padding-top:5px;padding-bottom:15px"><h2 style="Margin:0;font-family:lato,'helvetica neue',helvetica,arial,sans-serif;letter-spacing:0;font-size:20px;font-style:normal;font-weight:bold;line-height:24px;color:#333333">Permintaan Ganti Password&nbsp;</h2></td> </tr> <tr> <td align="left" style="padding:0;Margin:0;padding-bottom:10px"><p style="Margin:0;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;line-height:23px;letter-spacing:0;color:#555555;font-size:15px"><strong>Halo User,&nbsp;</strong></p></td> </tr> <tr> <td align="left" style="padding:0;Margin:0;padding-bottom:10px;padding-top:10px"><p style="Margin:0;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;line-height:23px;letter-spacing:0;color:#555555;font-size:15px">Sistem kami baru saja menerima permintaan Anda untuk melakukan ganti password sebelum email ini dikirimkan.&nbsp;&nbsp;Kode akan berlaku selama 5 menit setelah email ini dikirimkan dan jangan pernah membagikan kode berikut kesiapapun.&nbsp;</p></td> </tr> <tr> <td align="left" style="padding:0;Margin:0;padding-bottom:10px;padding-top:10px"><p style="Margin:0;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;line-height:23px;letter-spacing:0;color:#555555;font-size:15px">Kode : ${_code}</p></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table> <table class="m_-6415224778485533433es-footer" cellspacing="0" cellpadding="0" align="center" style="border-collapse:collapse;border-spacing:0px;width:100%;table-layout:fixed!important;background-color:transparent;background-repeat:repeat;background-position:center top"> <tbody><tr> <td align="center" style="padding:0;Margin:0"> <table class="m_-6415224778485533433es-footer-body" style="border-collapse:collapse;border-spacing:0px;background-color:transparent;width:600px" cellspacing="0" cellpadding="0" align="center"> <tbody><tr> <td align="left" style="Margin:0;padding-top:40px;padding-right:40px;padding-left:40px;padding-bottom:40px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr> <td valign="top" align="center" style="padding:0;Margin:0;width:520px"> <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse:collapse;border-spacing:0px"> <tbody><tr> <td align="left" style="padding:0;Margin:0;padding-bottom:10px"><p style="Margin:0;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;line-height:23px;letter-spacing:0;color:#666666;font-size:15px">This email was sent to you from KitaStack Email Address</p></td> </tr> <tr> <td align="left" style="padding:0;Margin:0"><p style="Margin:0;font-family:helvetica,'helvetica neue',arial,verdana,sans-serif;line-height:23px;letter-spacing:0;color:#666666;font-size:15px">Copyright Â© 2023&nbsp;<strong>KitaStack</strong>, All Rights Reserved.<br></p></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table></td> </tr> </tbody></table><div class="yj6qo"></div><div class="adL"> </div></div><div class="adL"> </div></div>`;

import Controller from ".";
import { Request, Response, NextFunction } from "express";
import crypto from "crypto";
import * as uuid from "uuid";

import UsersModel from "../models/Users";
import AuthModel from "../models/Auth";
// import UserValidator from "../validator/User";

import jwt from "jsonwebtoken";
import ErrorHandle from "../middleware/error";
import { nodeMailer } from "../utils/Mailer";

let tokensEmail: any[] = [];

export default class Auth {
  public static readonly collection: string = "Users";

  static getAccount(account: any) {
    account._id = account._id || uuid.v4();
    return {
      _id: account?._id,
      userId: account?.userId,
      email: account?.email,
      picture: account?.picture,
      roles: account?.roles,
      username: account?.username,
      isEmailVerified: account?.isEmailVerified,
      _createdDate: new Date(account?._createdDate),
    };
  }

  static async generateAccessToken(user: any): Promise<string> {
    // console.log("generateAccessToken", user);

    return jwt.sign(user, process.env.ACCESS_SECRET as string, {
      expiresIn: "30m",
    });
  }
  static async generateRefreshToken(account: any) {
    const accountJWT = Auth.getAccount(account);
    const accessToken = await Auth.generateAccessToken(accountJWT);
    const refreshToken = jwt.sign(
      accountJWT,
      process.env.REFRESH_SECRET as string
    );
    // if (account) {
    //   await AuthModel.deleteMany({
    //     // $and: [{ userId: account.userId || account._id }],
    //     $and: [{ _id: account._id }],
    //   });
    // }
    await AuthModel.create(account);
    return { accessToken, refreshToken };
  }
  static async key(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<Response | void> {
    try {
      const controller: Controller = new Controller(UsersModel);
      const refresh = req.query.payload;
      if (refresh == null) {
        return res.status(400).json({
          message: "Token tidak terdefinisi",
          success: false,
        });
      }
      jwt.verify(
        refresh as string,
        process.env.REFRESH_SECRET as string,
        async (err: any, user: any) => {
          user = Auth.getAccount(user);
          if (
            err ||
            !(await AuthModel.exists({ _id: user?._id, userId: user?.userId }))
          )
            return res.status(401).json({
              message: "Token invalid",
              success: false,
            });
          const account = await controller.model.findOne({
            email: new RegExp(`^${user?.email}$`, "gi"),
          });

          const accessToken = await Auth.generateAccessToken(user);
          res.json({ accessToken: accessToken });
        }
      );
    } catch (error: any) {
      ErrorHandle(error, req, res, next);
    }
    // const exist = await CurrentLogin.countDocuments({ _id: refreshToken });
    // if (exist !== 1) return res.sendStatus(403);
  }
  static async login(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<Response | void> {
    try {
      const controller: Controller = new Controller(UsersModel);

      const email = String(req.body.email)?.toLowerCase()?.trim();
      const password = req.body.password;
      if (!email || !password) {
        return res.status(400).json({
          message: "Email dan password harap diisi",
          success: false,
        });
      }

      const checkUser = await controller.model.findOne({
        email: new RegExp(`^${email}$`, "gi"),
      });

      if (checkUser == null || !checkUser?._id || email != checkUser?.email) {
        return res.status(400).json({
          message: "Pengguna belum terdaftar",
          success: false,
        });
      }
      // @compare password
      const dummyPassword = crypto
        .createHash("sha256", process.env.HASH_SECRET as any)
        .update(password)
        .digest("hex");

      if (dummyPassword !== checkUser?.password) {
        return res.status(400).json({
          message: "Password yang dimasukkan salah",
          success: false,
        });
      }

      const account = {
        userId: checkUser?._id,
        email: checkUser?.email,
        picture: checkUser?.picture,
        roles: checkUser?.roles,
        username: checkUser?.username,
        isEmailVerified: checkUser?.isEmailVerified,
        _createdDate: checkUser?._createdDate,
      };

      const key = await Auth.generateRefreshToken(account);

      res.status(200).json({
        message: "Berhasil login",
        result: {
          ...account,
          key,
        },
        success: true,
      });
    } catch (error: any) {
      ErrorHandle(error, req, res, next);
    }
  }
  static async logout(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<Response | void> {
    try {
      const user = jwt.decode(req.body.token) as any;
      const result = await AuthModel.deleteOne({ _id: user?._id });

      if (!user) {
        return res.status(400).json({
          message: "Token tidak terdefinisi",
          success: false,
        });
      }

      //user  { acknowledged: true, deletedCount: 1 }
      return res.status(201).json({
        message: "Berhasil logout",
        success: true,
      });
    } catch (error: any) {
      ErrorHandle(error, req, res, next);
    }
    // const exist = await CurrentLogin.countDocuments({ _id: refreshToken });
    // if (exist !== 1) return res.sendStatus(403);
  }
  static async sendResetPasswordByEmail(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<Response | void> {
    try {
      const email = req.body.email as string;
      // const redirect = req.body.redirect as string;
      if (!email) {
        return res.status(400).json({
          message: "Email tidak terdefinisi",
          success: false,
        });
      }
      // if (!redirect) {
      //   return res.status(400).json({
      //     message: "Link untuk redirect tidak terdefinisi",
      //     success: false,
      //   });
      // }
      // if (redirect.split("").reverse()?.[0] === "/") {
      //   return res.status(400).json({
      //     message: "Link tidak boleh memiliki karakter akhir slash (/)",
      //     success: false,
      //   });
      // }
      const finder = await UsersModel.findOne({
        email,
      });

      if (finder) {
        if (tokensEmail.find((it) => it.email === email)) {
          tokensEmail = tokensEmail?.filter((it) => it.email !== email);
        }
        const token =
          crypto
            .createHash("sha256", process.env.EMAIL_SECRET as any)
            .update(email + Math.floor(Date.now() / 1000))
            .digest("hex")
            ?.substring(0, 4)
            ?.toUpperCase() + (tokensEmail?.length || 0).toString();
        // const token = jwt.sign(
        //   {
        //     email,
        //     userId: finder._id,
        //   },
        //   process.env.EMAIL_SECRET as string,
        //   {
        //     expiresIn: "15m",
        //   }
        // );

        ``;
        // const message = `Berikut kode OTP untuk mengganti password Anda. Jangan pernah membagikan kode berikut kesiapapun!. KODE: ${token} </br></br> Berlaku selama 5 menit.`;
        const message = emailTemplate(token as string);
        await nodeMailer(email, "Reset Password", message);
        tokensEmail.push({
          email,
          token,
        });
        setTimeout(() => {
          tokensEmail = tokensEmail?.filter(
            (it) => it.token !== token || it.email !== email
          );
        }, 300000);

        return res.status(201).json({
          success: true,
          message: `Kode 5 digit sudah dikirim ke email ${email}`,
          result: token,
        });
      }
      return res.status(400).json({
        success: false,
        message: "Gagal mengirim kode (email tidak terdaftar)",
      });
    } catch (error: any) {
      ErrorHandle(error, req, res, next);
    }
  }
  static async doResetPasswordByEmail(
    req: Request,
    res: Response,
    next: NextFunction
  ): Promise<Response | void> {
    try {
      const token = tokensEmail?.find(
        (it) => it.token === (req.body.token as string).trim()
      );
      if (!token) {
        return res.status(401).send({
          message: "Kode yang Anda masukkan invalid",
          success: false,
        });
      }
      // const oldPassword = req.body.oldPassword as string;
      const password = req.body.password as string;

      if (password.length < 8) {
        return res.status(400).send({
          message: "Password minimal terdiri dari 8 karakter",
          success: false,
        });
      }

      const controller: Controller = new Controller(UsersModel);
      const account = await controller.model.findOneAndUpdate(
        { email: token.email },
        {
          password: crypto
            .createHash("sha256", process.env.HASH_SECRET as any)
            .update(password)
            .digest("hex"),
          _updatedDate: new Date(),
        },
        {
          new: true,
        }
      );

      tokensEmail = tokensEmail?.filter(
        (it) => it.token !== (token.token || token)
      );

      res.json({
        success: true,
        message: `Berhasil reset password akun ${account?.email}`,
        result: account,
      });
    } catch (error: any) {
      ErrorHandle(error, req, res, next);
    }
    // const exist = await CurrentLogin.countDocuments({ _id: refreshToken });
    // if (exist !== 1) return res.sendStatus(403);
  }

  static async resetPassword(
    req: Request | any,
    res: Response,
    next: NextFunction
  ): Promise<Response | void> {
    try {
      const oldPassword = req.body.oldPassword as string;
      const newPassword = req.body.password as string;

      if (!oldPassword || !newPassword) {
        return res.status(400).send({
          message: "Pastikan password lama dan baru terisi",
          success: false,
        });
      }

      if (oldPassword?.length < 8 || newPassword.length < 8) {
        return res.status(400).send({
          message: "Password minimal terdiri dari 8 karakter",
          success: false,
        });
      }

      const controller: Controller = new Controller(UsersModel);
      let account = await controller.model.findById(req?.user?.userId);
      if (
        account &&
        account.password !==
          crypto
            .createHash("sha256", process.env.HASH_SECRET as any)
            .update(oldPassword)
            .digest("hex")
      ) {
        return res.status(400).send({
          message: "Password lama yang Anda masukkan tidak sesuai",
          success: false,
        });
      }

      account = await controller.model.findByIdAndUpdate(req?.user?.userId, {
        password: crypto
          .createHash("sha256", process.env.HASH_SECRET as any)
          .update(newPassword)
          .digest("hex"),
        _updatedDate: new Date(),
      });

      if (account) {
        delete account.password;
        return res.status(201).json({
          success: true,
          message: `Berhasil reset password akun ${account.email}`,
          result: account,
        });
      }

      return res.status(401).send({
        message: `Gagal reset password akun ${account.email}`,
        success: false,
      });
    } catch (error: any) {
      ErrorHandle(error, req, res, next);
    }
  }
}
